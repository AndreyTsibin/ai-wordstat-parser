# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Yandex Wordstat API parser for automating SEO keyword research. The workflow integrates Claude Code:
1. Claude generates keyword queries based on business info in `config.json`
2. Parser fetches data from Yandex Wordstat API
3. Results are saved as formatted Markdown tables in `results.md`
4. Claude analyzes results and creates content plans

## Development Commands

**Run the parser:**
```bash
python parser.py
```

**Setup (first time):**
```bash
# Copy environment template
cp .env.example .env
# Edit .env and add your Yandex Wordstat OAuth token
# Edit config.json with business information
# Generate queries.txt (can be done by Claude Code)
```

**Testing specific functionality:**
- Parser loads config correctly: Run `python parser.py` with minimal queries
- API connectivity: Ensure `.env` has valid token before running
- Edge cases: Test with empty `queries.txt`, invalid token, missing `.env`

## Architecture

**Technology Stack:**
- Python 3.8+ (stdlib only, no external dependencies)
- Uses: `urllib.request`, `json`, `time`, `datetime`, `os`, `sys`

**Data Flow:**
```
config.json + queries.txt ‚Üí parser.py ‚Üí API requests ‚Üí results.md
```

**Core Components:**

1. **Configuration Loading** (`load_env`, `load_config`, `load_queries`)
   - Reads `.env` for OAuth token
   - Loads business settings from `config.json`
   - Reads search queries from `queries.txt`
   - Validates required fields and files

2. **API Client** (`fetch_top_requests`)
   - Endpoint: `https://api.wordstat.yandex.net/v1/topRequests`
   - Implements retry logic (3 attempts with 5s delay)
   - Rate limiting: 2s delay between requests (configurable)
   - Error handling for HTTP and network errors

3. **Keyword Categorization** (`categorize_phrase`)
   - Classifies phrases into types: Commercial üõí, Informational üìö, Price üí∞, Comparison ‚öñÔ∏è, Local üìç
   - Priority order: price > commercial > informational > comparison
   - Uses keyword dictionaries in `CATEGORY_KEYWORDS`
   - Adds local flag when city name appears in phrase

4. **Duplicate Tracking** (`track_duplicates`)
   - Tracks phrases appearing in multiple queries
   - Marks duplicates as "–≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ X –∑–∞–ø—Ä–æ—Å–∞—Ö"

5. **Markdown Generation** (`generate_*` functions)
   - Creates formatted tables with emoji markers
   - Formats numbers with thousand separators
   - Generates summary statistics (top-10 by frequency)
   - Outputs to `results.md`

## File Structure

- `config.json` - Business info (site, niche, city, services, region_code) + parser settings
- `queries.txt` - Search queries (one per line, typically generated by Claude Code)
- `parser.py` - Main parser script
- `.env` - OAuth token (gitignored, use `.env.example` as template)
- `results.md` - Generated output with tables (gitignored)
- `ARCHITECTURE.md` - Detailed technical documentation
- `PLANNING.md` - Development roadmap and phases
- `TASKS.md` - Atomic implementation tasks

## Coding Standards

**Naming:**
- Variables/functions: `snake_case`
- Classes: `PascalCase`
- Constants: `UPPER_SNAKE_CASE`

**Style:**
- PEP 8 compliance
- Max line length: 100 characters
- Docstrings for all functions
- Type hints where applicable

**Error Handling:**
- Try-except blocks for all external calls (API, file I/O)
- Graceful degradation: skip failed queries, continue processing
- User-friendly error messages with emoji indicators
- Exit with `sys.exit(1)` for critical errors (missing config, invalid token)

**Logging:**
- Console output with emoji for visual clarity (üöÄ start, ‚úÖ success, ‚ùå error, ‚è≥ waiting)
- Progress indicator: `[1/15]` format
- Execution time tracking

## Critical Implementation Details

**API Integration:**
- Authorization: `Bearer {token}` in headers
- Request payload includes: `phrase`, `regions` array, `devices` array
- Response contains: `totalCount` (monthly impressions), `topRequests` array with phrase/count pairs

**Configuration:**
- `region_code`: Yandex region ID (e.g., 213 for Moscow)
- `top_results_limit`: Number of phrases to display per query (default: 50)
- `delay_between_requests`: Rate limiting in seconds (default: 2)
- `devices`: Array of `["desktop", "mobile"]`

**Security:**
- OAuth token stored in `.env` (not committed)
- `.gitignore` excludes: `.env`, `results.md`, `__pycache__/`

**Performance:**
- Expected: 15-20 queries in 40-60 seconds
- Memory: <50 MB (all data kept in RAM)
- No caching between runs (idempotent - each run overwrites `results.md`)

## Working with Claude Code

**Generating queries:**
Claude Code should read `config.json` and generate 15-20 relevant search queries based on:
- Business niche
- Services offered
- City/region
- Competitors (optional analysis)
- Budget/priorities

**Analyzing results:**
After parser completes, Claude Code should:
1. Read `results.md`
2. Cluster keywords by theme/intent
3. Prioritize based on frequency and commercial intent
4. Create content plan with recommended articles

## Common Tasks

**Adding new category types:**
1. Add keywords to `CATEGORY_KEYWORDS` dictionary
2. Add emoji to `CATEGORY_EMOJI` dictionary
3. Update priority order in `categorize_phrase()` if needed

**Supporting new API methods:**
- Yandex Wordstat offers `/v1/dynamics` (trends) and `/v1/regions` (geographic distribution)
- Follow same pattern as `fetch_top_requests()`: create dedicated function, add to main processing loop

**Extending Markdown output:**
- All generation logic in `generate_*` functions
- Add new sections by creating function and calling from `save_results()`

## Development Workflow

**For new features (per PLANNING.md):**
1. Each task = one atomic commit
2. Follow sequential order: infrastructure ‚Üí config ‚Üí API ‚Üí categorization ‚Üí output ‚Üí logging ‚Üí testing
3. Test after each task before proceeding
4. Use conventional commits: `feat:`, `fix:`, `docs:`

**When making changes:**
- Preserve idempotent behavior (reruns should work identically)
- Maintain backward compatibility with existing `config.json`
- Update README.md if user-facing behavior changes
- Test all edge cases (missing files, invalid tokens, API errors)

## Notifications

The project has macOS notification hooks configured in `.claude/settings.json`:
- Stop: Glass sound when task completes
- Notification: Ping sound when input needed
- SubagentStop: Tink sound when subtask completes
