# ARCHITECTURE.md

## 📋 Технический контекст

Парсер для Яндекс Вордстат API, который автоматизирует сбор поисковых запросов для SEO-планирования. Работает в связке с Claude Code: Claude генерирует список запросов на основе бизнес-информации → парсер собирает данные через API → Claude анализирует результаты и создаёт контент-план.

---

## 🛠 Технологический стек

### Язык: **Python 3.8+**

**Обоснование:**
- ✅ Быстрая разработка простых скриптов
- ✅ Встроенные библиотеки для HTTP (`urllib`) и JSON
- ✅ Установлен по умолчанию на macOS
- ✅ Простая интеграция с Claude Code через файловую систему

### Зависимости: **Нулевые (только stdlib)**

**Обоснование:**
- Парсер использует только встроенные модули Python
- Не требует `pip install` и управления виртуальными окружениями
- Запускается сразу после клонирования репозитория

**Используемые модули:**
- `urllib.request` — HTTP-запросы к API
- `json` — парсинг конфигурации и ответов API
- `time` — задержки между запросами
- `datetime` — временные метки в логах

---

## 🏗 Архитектура системы

### Компоненты:

```
┌─────────────────┐
│  config.json    │ ← Пользователь заполняет вручную
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  Claude Code    │ → Генерирует queries.txt
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│   parser.py     │ → Парсит API Вордстата
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  results.md     │ ← Markdown с таблицами и категориями
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  Claude Code    │ → Создаёт content-plan.md
└─────────────────┘
```

### Data Flow:

1. **Input:** `config.json` + `queries.txt`
2. **Processing:** API requests → JSON responses → категоризация
3. **Output:** `results.md` (Markdown таблицы)

---

## 📦 Структура проекта

```
wordstat-parser/
│
├── config.json              # Конфигурация (токен, регион, настройки)
├── queries.txt              # Список запросов (генерирует Claude Code)
├── parser.py                # Основной скрипт парсера
├── results.md               # Результаты парсинга
│
├── ARCHITECTURE.md          # Этот файл
├── PLANNING.md              # Дорожная карта
├── TASKS.md                 # Задачи для Claude Code
└── README.md                # Инструкция по использованию
```

---

## 🔧 Ключевые модули парсера

### 1. **ConfigLoader**
- Читает `config.json`
- Валидирует обязательные поля (токен, регион)
- Возвращает словарь настроек

### 2. **QueryReader**
- Читает `queries.txt` построчно
- Удаляет пустые строки и пробелы
- Возвращает список запросов

### 3. **WordstatAPI**
- Отправляет POST-запросы к `/v1/topRequests`
- Обрабатывает ошибки (ретраи 3 раза)
- Возвращает JSON с фразами и частотностью

### 4. **KeywordCategorizer**
- Классифицирует фразы по типам:
  - 🛒 Коммерческий (`купить`, `заказать`, `под ключ`)
  - 📚 Информационный (`как`, `что такое`, `почему`)
  - 💰 Ценовой (`цена`, `стоимость`, `сколько стоит`)
  - 📍 Локальный (содержит название города)

### 5. **DuplicateHandler**
- Отслеживает уникальные фразы
- Помечает дубликаты: `"встречается в 3 запросах"`

### 6. **MarkdownGenerator**
- Форматирует результаты в таблицы
- Добавляет эмодзи и нумерацию
- Создаёт сводную статистику

---

## 📊 Стандарты кодирования

### Naming Conventions:
- **Переменные:** `snake_case` (`top_results_limit`)
- **Функции:** `snake_case` (`read_config()`)
- **Классы:** `PascalCase` (`WordstatAPI`)
- **Константы:** `UPPER_SNAKE_CASE` (`API_BASE_URL`)

### Code Style:
- **PEP 8** — стандарт Python
- Максимальная длина строки: 100 символов
- Docstrings для всех функций
- Type hints где возможно

### Error Handling:
- Try-except блоки для всех внешних вызовов
- Логирование ошибок в консоль
- Graceful degradation (пропуск неудачных запросов)

### Logging:
- Эмодзи для визуальной навигации
- Прогресс-бар в консоли (`[1/15]`)
- Таймстампы в критичных местах

---

## 🔐 Безопасность

- Токен хранится локально в `config.json` (не коммитится в Git)
- `.gitignore` исключает `config.json` и `results.md`
- Задержка между запросами (rate limiting)

---

## 🚀 Best Practices

### 1. **Идемпотентность**
- Повторный запуск перезаписывает `results.md`
- Не накапливает мусор

### 2. **Fail-safe**
- При ошибке API: 3 ретрая → пропуск запроса → продолжение
- Частичные результаты сохраняются

### 3. **Читабельность**
- Markdown с таблицами и эмодзи
- Нумерация для удобной навигации

### 4. **Расширяемость**
- Легко добавить новые методы API (`/v1/dynamics`, `/v1/regions`)
- Категоризатор работает через словари (легко дополнять)

---

## 📈 Производительность

**Ожидаемые показатели:**
- 15-20 запросов = ~40-60 секунд
- Задержка: 2 сек между запросами
- Память: <50 MB (всё в RAM)

**Оптимизация:**
- Нет избыточных копирований данных
- Потоковая запись в файл (не накапливаем всё в памяти)

---

## 🧪 Тестирование

**Минимальный набор:**
- Проверка чтения `config.json` с невалидными данными
- Мок-ответ от API для тестирования категоризатора
- Проверка дубликатов

**Note:** Для MVP тесты опциональны, код простой и легко отлаживается вручную.